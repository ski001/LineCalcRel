// ---------------
// 21ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ 
// CPU ã¨ USER 2äººå‹è² 
// ---------------
{
 // ------------------------------
 // ã‚²ãƒ¼ãƒ ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹
 // ------------------------------
 class(CMain,
  {
   setrcom(cls,"21ã‚²ãƒ¼ãƒ "),
  
  // -----------------------------------------------------------------------
  // -----------------------------------------------------------------------
  // ---------------
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¦ªã‚¯ãƒ©ã‚¹
  // @1:CCardã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚½ãƒ¼ã‚¹ID
  // @2:CDispã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚½ãƒ¼ã‚¹ID
  // @3:è¡¨ç¤ºxåº§æ¨™
  // @4:è¡¨ç¤ºyåº§æ¨™
  // ---------------
   class(cls.CPlayer,
  // ++
    {
     setrcom(cls,"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¦ªã‚¯ãƒ©ã‚¹"),
     cls.card = @1, // CCardã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚½ãƒ¼ã‚¹ID
     cls.disp = @2, // CDispã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚½ãƒ¼ã‚¹ID
     cls.x = @3, // è¡¨ç¤ºåº§æ¨™
     cls.y = @4, // è¡¨ç¤ºåº§æ¨™
     cls.money = 100 , // æ‰€æŒé‡‘
     cls.bet = 0 , // æ›ã‘é‡‘
     cls.lv = 1 , // ãƒ¬ãƒ™ãƒ«
     cls.name = "" , // åå‰
  
  // -----------------------------------------------------------------------
     // -------------
     // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã‹è€ƒãˆã‚‹(override)
     // return : 1->å¼•ã 0->ãã®ã¾ã¾
     // -------------
     fnc(cls.consider,
  // ++
      {
       1
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // æ›ã‘é‡‘ã‚’æ›ã‘ã‚‹(override)
     // -------------
     fnc(cls.betMoney,
  // ++
      {
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // æ‰‹æœ­ã®æ–‡å­—åˆ—ã‚’å¾—ã‚‹(override)
     // @1:0->ã‚²ãƒ¼ãƒ ä¸­ 1->ã‚²ãƒ¼ãƒ çµ‚äº†
     // return : æ‰‹æœ­æ–‡å­—åˆ—
     // -------------
     fnc(cls.getCardStr,
  // ++
      {
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // æ‰‹æœ­ã®æƒ…å ±æ–‡å­—åˆ—ã‚’å¾—ã‚‹(override)
     // @1:0->ã‚²ãƒ¼ãƒ ä¸­ 1->ã‚²ãƒ¼ãƒ çµ‚äº†
     // return : æ‰‹æœ­æ–‡å­—åˆ—
     // -------------
     fnc(cls.getInfoStr,
  // ++
      {
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // æƒ…å ±è¡¨ç¤º
     // @1:0->ã‚²ãƒ¼ãƒ ä¸­ 1->ã‚²ãƒ¼ãƒ çµ‚äº†
     // -------------
     fnc(cls.dispInfo,
  // ++
      {
       st = this.getCardStr(@1),
       info = this.getInfoStr(@1),
       this.disp.dprint(this.x , this.y ,"+------" & this.name & "------"),
       this.disp.dprint(this.x , this.y + 1 , "|CARD :[" & st & "]"),
       this.disp.dprint(this.x , this.y + 2 , "|MONEY:" & this.money & info & "     "),
       this.disp.dprint(this.x , this.y + 3 , "|BET  :" & this.bet & "                   ")
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  
  // -----------------------------------------------------------------------
     // -------------
     // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªã‚¢
     // -------------
     fnc(cls.init,
  // ++
      {
       del(this.cardlis),
       this.bet = 0 
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // æ‰€æŒé‡‘ãƒªã‚»ãƒƒãƒˆ
     // -------------
     fnc(cls.moneyInit,
  // ++
      {
       this.money = 100 ,
       if(this.lv > 1 , 
        this.money = this.money = this.moneybk * 2
       ),
       this.moneybk = this.money,
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // ã‚«ãƒ¼ãƒ‰ã‚’1æšå¼•ã
     // return : 1->å¼•ã„ãŸ 0->ãã®ã¾ã¾
     // -------------
     fnc(cls.getCard,
  // ++
      {
       ret = if(len(this.cardlis) <= 1 , 1 , this.consider), // å¼•ãã‹è€ƒãˆã‚‹
       if(ret ,
        this.cardlis[len(this.cardlis)] = this.card.getCard // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
       ),
       ret
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // ã‚«ãƒ¼ãƒ‰ã®åˆè¨ˆã§ä¸€ç•ªã„ã„ç‚¹æ•°ã‚’è¿”ã™
     // @1:ã™ã¹ã¦ã®åˆè¨ˆã‚’è¿”ã™é…åˆ—å
     // [@2:ãƒã‚¹ãƒˆæ•°]
     // [@3:ç›´å‰ã¾ã§ã®åˆè¨ˆ]
     // return : å…¨ã¦ã®åˆè¨ˆ
     //          callcnt.(@1)[] : å…¨ã¦ã®åˆè¨ˆ
     // -------------
     fnc(cls.getCardSum,
  // ++
      {
       if(!isdef(@2),(/*ãƒˆãƒƒãƒ—å‘¼ã³å‡ºã—*/del(this.sumlis),cnt = 0 ,sum = 0), (/*2å›ç›®ä»¥é™*/cnt = @2,sum = @3)), // ãƒã‚¹ãƒˆæ•°,åˆè¨ˆ
       if(!isdef(this.cardlis[cnt]),(/*çµ‚äº†*/ this.sumlis[len(this.sumlis)] = sum,return(sum))), // æœ€å¾Œã¾ã§è¨ˆç®—ã—ãŸã‚‰ this.sumlis ã«åˆè¨ˆã‚’è¿½åŠ 
       lis = this.cardlis[cnt].getVal, // å€¤ãƒªã‚¹ãƒˆã‚’å¾—ã‚‹
       // å€¤ãƒªã‚¹ãƒˆåˆ†è¨ˆç®—
       sumbk = sum ,
       fordim(tag,lis,
        {
         sum = sum + lis[tag],
         this.getCardSum(@1, cnt + 1 , sum), // æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã®è¨ˆç®—
         sum = sumbk
        }
       ),
       // this.sumlis ã«ãƒªã‚¹ãƒˆãŒå‡ºæ¥ã¦ã„ã‚‹
       if(!isdef(@2),
        {
         // ãƒˆãƒƒãƒ—å‘¼ã³å‡ºã—ãªã®ã§ä¸€ç•ªã„ã„æ‰‹ã‚’è¿”ã™
         bestval = 0 ,
         fordim(tag,this.sumlis,
          {
           v = this.sumlis[tag],
           if(v <= 21 && bestval < v , bestval = v)
          }
         ),
         if(bestval == 0 && len(this.cardlis) > 0 ,
          {
           // 21ä»¥ä¸Š
           sort(this.sumlis),
           fordim(tag,this.sumlis,
            {
             bestval = this.sumlis[tag],
             break
            }
           )
          }
         ),
         // å…¨ã¦ã®åˆè¨ˆã‚’ callcnt.(@1)[] ã«è¿”ã™
         callcnt.(@1) = this.sumlis, 
         sort(callcnt.(@1)),
         return(bestval)
        }
       )
      }
  // ++
     )
  // -----------------------------------------------------------------------
    }
  // ++
   ),
  // -----------------------------------------------------------------------
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
  // -----------------------------------------------------------------------
   // ---------------
   // CPUã‚¯ãƒ©ã‚¹
   // CPU ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
   // CPlayer ã‚’ç¶™æ‰¿
   // @1:CCardã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚½ãƒ¼ã‚¹ID
   // @2:CDispã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚½ãƒ¼ã‚¹ID
   // @3:è¡¨ç¤ºxåº§æ¨™
   // @4:è¡¨ç¤ºyåº§æ¨™
   // ---------------
   class(cls.CCpu,
  // ++
    {
     cls = this.newCPlayer(@1,@2,@3,@4), // ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚½ãƒ¼ã‚¹ä½œæˆ(CPlayerç¶™æ‰¿)
     setrcom(cls,"CPU:" & getrcom(cls)),
     cls.name = "CPU", // åå‰
  
  // -----------------------------------------------------------------------
     // -------------
     // æ‰‹æœ­ã®æ–‡å­—åˆ—ã‚’å¾—ã‚‹(override)
     // @1:0->ã‚²ãƒ¼ãƒ ä¸­ 1->ã‚²ãƒ¼ãƒ çµ‚äº†
     // return : æ‰‹æœ­æ–‡å­—åˆ—
     // -------------
     fnc(cls.getCardStr,
  // ++
      {
       st = "",
       first = if(@1 , 0 , 1) ,
       fordim(tag,this.cardlis,
        {
         v = if(first , (first = 0 , "* "), this.cardlis[tag].getStr),
         st = st & v & " "
        }
       )
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // æ‰‹æœ­ã®æƒ…å ±æ–‡å­—åˆ—ã‚’å¾—ã‚‹(override)
     // @1:0->ã‚²ãƒ¼ãƒ ä¸­ 1->ã‚²ãƒ¼ãƒ çµ‚äº†
     // return : æ‰‹æœ­æ–‡å­—åˆ—
     // -------------
     fnc(cls.getInfoStr,
  // ++
      {
       ""
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // æ›ã‘é‡‘ã‚’æ›ã‘ã‚‹(override)
     // -------------
     fnc(cls.betMoney,
  // ++
      {
       // æ‰‹æœ­ã‹ã‚‰æœ€é«˜å‰²åˆã‚’æ±ºã‚ã‚‹
       bestval = this.getCardSum(^tmp), // 1ï½11(10%ï½50%)
       betrate = bestval / 11 * 0.5 ,
       if(len(tmp) > 1 ,
        { // A , JOKER ã‚’å¼•ã„ãŸ
         betrate = betrate + 0.20 , // 70%
         if(len(tmp) > 2 ,
          { // JOKER ã‚’å¼•ã„ãŸ
           betrate = betrate + 0.20 , // 90%
          }
         )
        }
       ),
  
       rng = this.money * betrate * 0.2 , // 20% ã®ç¯„å›²ã§ã¶ã‚‰ã™
       base = this.money * betrate - rng, // æœ€ä½æ›ã‘é‡‘
       this.bet = int(base + rnd(rng)),
       this.money = this.money - this.bet ,
       this.disp.blink(this.x , this.y + 4 , "    *BET:" & this.bet , 2),
       this.disp.dprint(this.x , this.y + 4 , "                         ")
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã‹è€ƒãˆã‚‹(override)
     // return : 1->å¼•ã 0->ãã®ã¾ã¾n
     // -------------
     fnc(cls.consider,
  // ++
      {
       missrate = (5 - this.lv) / 5 ,  // å¤±æ•—ãƒ¬ãƒ¼ãƒˆ
       if(missrate < 0 , missrate = 0),
  
       bestval = this.getCardSum(^tmp),
       cardrate = (18 - bestval) / 15 , // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ããƒ¬ãƒ¼ãƒˆ
       if(cardrate < 0 , cardrate = 0),
       if(len(tmp) > 1 && bestval < 21 , 
        { // A , JOKER
         cardrate = 0.5 , // A
         if(len(tmp) > 2 , 
          {
           cardrate = 1.0 , // JOKER
          }
         )
        }
       ),
  
       if(rnd(100) <= (cardrate * 100) ,
        {
         ans = 1 // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
        },
        {
         ans = 0 // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã‹ãªã„
        }
       ),
       if(rnd(100) < (missrate * 100) ,
        {
         ans = !ans // ãƒŸã‚¹
        }
       ),
       if(ans , 
        // get card
        {
         this.disp.blink(this.x , this.y + 4 , "    *GET CARD*" , 2),
        },
        // stay
        {
         this.disp.blink(this.x , this.y + 4 , "    *STAY*" , 2),
        }
       ),
       ans
      }
  // ++
     )
  // -----------------------------------------------------------------------
    }
  // ++
   ),
  // -----------------------------------------------------------------------
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
  // -----------------------------------------------------------------------
   // ---------------
   // USERã‚¯ãƒ©ã‚¹
   // USER ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
   // CPlayer ã‚’ç¶™æ‰¿
   // @1:CCardã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚½ãƒ¼ã‚¹ID
   // @2:CDispã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚½ãƒ¼ã‚¹ID
   // @3:è¡¨ç¤ºxåº§æ¨™
   // @4:è¡¨ç¤ºyåº§æ¨™
   // ---------------
   class(cls.CUser,
  // ++
    {
     cls = this.newCPlayer(@1,@2,@3,@4), // ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚½ãƒ¼ã‚¹ä½œæˆ(CPlayerç¶™æ‰¿)
     setrcom(cls,"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:" & getrcom(cls)),
     cls.name = "USER", // åå‰
  
  // -----------------------------------------------------------------------
     // -------------
     // æ‰‹æœ­ã®æ–‡å­—åˆ—ã‚’å¾—ã‚‹(override)
     // @1:0->ã‚²ãƒ¼ãƒ ä¸­ 1->ã‚²ãƒ¼ãƒ çµ‚äº†
     // return : æ‰‹æœ­æ–‡å­—åˆ—
     // -------------
     fnc(cls.getCardStr,
  // ++
      {
       st = "",
       fordim(tag,this.cardlis,
        {
         v = this.cardlis[tag].getStr,
         st = st & v & " "
        }
       )
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // æ‰‹æœ­ã®æƒ…å ±æ–‡å­—åˆ—ã‚’å¾—ã‚‹(override)
     // @1:0->ã‚²ãƒ¼ãƒ ä¸­ 1->ã‚²ãƒ¼ãƒ çµ‚äº†
     // return : æ‰‹æœ­æ–‡å­—åˆ—
     // -------------
     fnc(cls.getInfoStr,
  // ++
      {
       bestval = this.getCardSum(^sumlis),
       " BEST:" & bestval & " SUM LIST: {" & (st = "" , fordim(tag,sumlis,st = st & sumlis[tag] & "   ")) & "}"
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // æ›ã‘é‡‘ã‚’æ›ã‘ã‚‹(override)
     // -------------
     fnc(cls.betMoney,
  // ++
      {
       while(1 ,
        {
         bet = input("æ›ã‘é‡‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",0),
         if((this.money - bet) >= 0 && bet > 0 , (this.money = this.money - bet , this.bet = bet , break))
        }
       )
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã‹è€ƒãˆã‚‹(override)
     // return : 1->å¼•ã 0->ãã®ã¾ã¾
     // -------------
     fnc(cls.consider,
  // ++
      {
       this.disp.dprint(this.x , this.y + 4 , "GET CARD:y STAY:n"),
       this.disp.disp,
       y = 0 , 
       n = 0 ,
       while(!y && !n , (delay(10) , y = rinput(^y) , n = rinput(^n))),
       this.disp.dprint(this.x , this.y + 4 , "                 "),
       if(y , 
        // get card
        {
         this.disp.blink(this.x , this.y + 4 , "    *GET CARD*" , 2),
        },
        // stay
        {
         this.disp.blink(this.x , this.y + 4 , "    *STAY*" , 2),
        }
       ),
       this.disp.dprint(this.x , this.y + 4 , "              "),
       this.disp.disp,
       y
      }
  // ++
     )
  // -----------------------------------------------------------------------
    }
  // ++
   ),
  // -----------------------------------------------------------------------
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
  // -----------------------------------------------------------------------
   // ---------------
   // OneCARDã‚¯ãƒ©ã‚¹
   // ã‚«ãƒ¼ãƒ‰1ã¤ã®ã‚¯ãƒ©ã‚¹
   // @1:ã‚«ãƒ¼ãƒ‰ç•ªå·
   // @2:ã‚·ãƒ£ãƒƒãƒ•ãƒ«ä¹±æ•°
   // ---------------
   class(cls.COneCard,
  // ++
    {
     setrcom(cls,"ã‚«ãƒ¼ãƒ‰ï¼‘ã¤"),
  
     cls.num = @1 , // ã‚«ãƒ¼ãƒ‰ç•ªå·
     cls.used = 0 , // å¼•ã‹ã‚ŒãŸå¾Œã‹
     cls.rndnum = @2 , // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç”¨ä¹±æ•°è¨­å®š
  
  // -----------------------------------------------------------------------
     // -------------
     // ã‚«ãƒ¼ãƒ‰ã®å€¤ã‚’å¾—ã‚‹
     // return : å€¤ã®é…åˆ—
     // -------------
     fnc(cls.getVal,
  // ++
      {
       // Jãƒ»Qãƒ»K
       if(this.num == 11 || this.num == 12 || this.num == 13 , return([10])),
       // A
       if(this.num == 1 , return([1 , 11])),
       // JOKER
       if(this.num == 14 , 
        return([0 , 1 , 10 ,11])
       ),
       // 2ï½10
       return([this.num])
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // ã‚«ãƒ¼ãƒ‰ã®æ–‡å­—ã‚’å¾—ã‚‹
     // -------------
     fnc(cls.getStr,
  // ++
      {
       // Jãƒ»Qãƒ»K
       if(this.num == 11 ,return("J ")),
       if(this.num == 12 ,return("Q ")),
       if(this.num == 13 ,return("K ")),
       // A
       if(this.num == 1 ,return("A ")),
       // JOKER
       if(this.num == 14 ,return("ğŸƒ ")), 
       // 2ï½9
       if(this.num >= 2 && this.num <= 9 , return(this.num & " ")),
       // 10
       return(10)
      }
  // ++
     )
  // -----------------------------------------------------------------------
    }
  // ++
   ),
  // -----------------------------------------------------------------------
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
  // -----------------------------------------------------------------------
  
   // ---------------
   // CARDã‚¯ãƒ©ã‚¹
   // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹
   // @1:ã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚½ãƒ¼ã‚¹ID
   // ---------------
   class(cls.CCard,
  // ++
    {
     setrcom(cls,"ã‚«ãƒ¼ãƒ‰"),
     cls.gm = @1 , // ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚½ãƒ¼ã‚¹IDä¿å­˜
  
  // -----------------------------------------------------------------------
     // -------------
     // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã®ç‚ºã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªä¹±æ•°ã‚’ä½œã‚‹
     // -------------
     fnc(cls.getRnd,
  // ++
      {
       while(1 , 
        {
         rndnum = rnd(10000),
         flg = 0 , 
         fordim(tag,this.cardlis,
          if(rndnum == this.cardlis[tag].rndnum , flg = 1)
         ),
         if(!flg , break) // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªä¹±æ•°å–å¾—æˆåŠŸ
        }
       ),
       rndnum
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // ã‚«ãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ã™ã‚‹
     // -------------
     fnc(cls.init,
  // ++
      {
       del(this.cardlis), // ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’æ¶ˆå»
       this.pos = 0 , // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãä½ç½®
  
       cnt = 0 , // é…åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
       for(num , 1 , 13 , 1 ,
        for(num2 , 1 , 4 , 1 , // ã‚¯ãƒ©ãƒ–ã€ãƒ€ã‚¤ãƒ¤ã€ãƒãƒ¼ãƒˆã€ã‚¹ãƒšãƒ¼ãƒ‰åˆ†
         {
          // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã®ç‚ºã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªä¹±æ•°ã‚’ä½œã‚‹
          rndnum = this.getRnd,
          this.cardlis[cnt] = this.gm.newCOneCard(num,rndnum) , // ã‚«ãƒ¼ãƒ‰ä½œæˆ
          cnt = cnt + 1
         }
        )
       ),
  
       // ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã‚’å…¥ã‚Œã‚‹
       rndnum = this.getRnd,
       this.cardlis[cnt] = this.gm.newCOneCard(14 ,rndnum),
  
       // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹
       sort(this.cardlis,"{v1 = this.cardlis[ind1].rndnum , v2 = this.cardlis[ind2].rndnum , if(v1 >   v2 , 1 , if(v1 == v2 , 0 , -1))}"),
      }
  // ++
     ),
  // -----------------------------------------------------------------------
  
  // -----------------------------------------------------------------------
     // -------------
     // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
     // -------------
     fnc(cls.getCard,
  // ++
      {
       cnt = 0 , 
       fordim(tag , this.cardlis , 
        {
         if(cnt == this.pos ,
          {
           this.pos = this.pos + 1 ,
           this.cardlis[tag].used = 1 ,
           return(this.cardlis[tag])
          }
         ),
         cnt = cnt + 1
        }
       ),
       -1 // ã‚«ãƒ¼ãƒ‰ãŒç„¡ã„
      }
  // ++
     )
  // -----------------------------------------------------------------------
    }
  // ++
   ),
  // -----------------------------------------------------------------------
  // -----------------------------------------------------------------------
  
  // ---------------
  // ã‚²ãƒ¼ãƒ ãƒ¡ã‚¤ãƒ³
  // ---------------
  
  // -----------------------------------------------------------------------
   // -------------
   // ç”»é¢è¡¨ç¤º
   // @1:0->ã‚²ãƒ¼ãƒ ä¸­ 1->ã‚²ãƒ¼ãƒ çµ‚äº†
   // -------------
   fnc(cls.dispGame,
    {
     this.cpu.dispInfo(@1),
     this.user.dispInfo(@1),
     this.disp.dprint(0 , 1 , " SCORE : " & this.score & " LEVEL : " & this.cpu.lv),
  
     this.disp.disp
    }
   ),
  // -----------------------------------------------------------------------
  
   // ãƒ¡ãƒ³ãƒå¤‰æ•°å®£è¨€
   cls.disp = newCDisp, // ä»®æƒ³ç”»é¢ä½œæˆ
   cls.card = cls.newCCard(cls), // CARD
   cls.cpu = cls.newCCpu(cls.card,cls.disp , 0 , 2), // CPU
   cls.user = cls.newCUser(cls.card,cls.disp , 30 , 2), // USER
   cls.score = 0 , // ã‚¹ã‚³ã‚¢
  
  // -----------------------------------------------------------------------
   // -------------
   // main ãƒ¡ãƒ³ãƒé–¢æ•°
   // -------------
   fnc(cls.main,
  // ++
    {
     // ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º
     this.disp.dprint(10 , 4 , "21 card game"),
     while(1 , 
      {
       this.disp.dprint(7 ,6 ,"Push sps to start"),
       this.disp.disp,
       delay(100),
       this.disp.dprint(7 ,6 ,"                 "),
       this.disp.disp,
       if(rinput(^sps), break),
       delay(50)
      }
     ),
  
     // åˆæœŸåŒ–
     this.card.init,
     this.cpu.init,
     this.user.init,
     this.cpu.moneyInit,
     this.user.moneyInit,
  
     clearcnt = 0 , // ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢ã¾ã§ã®ã‚«ã‚¦ãƒ³ãƒˆ
     while(this.cpu.money > 0 && this.user.money > 0 ,
      {
       // ç”»é¢åˆæœŸåŒ–
       this.disp.clear,
       this.disp.dprint(0 , 0 , "   ------------- TWENTY ONE -------------"),
  
       // åˆæœŸæ‰‹æœ­ã‚’é…ã‚‹
       this.cpu.getCard,
       this.user.getCard,
       this.dispGame(0),
  
       // æ›ã‘é‡‘ã‚’æ›ã‘ã‚‹
       this.cpu.betMoney,
       this.dispGame(0),
       this.user.betMoney,
       this.dispGame(0),
  
       // 1æšå¼•ã
       this.cpu.getCard,
       this.user.getCard,
       this.dispGame(0), 
  
       // ã‚‚ã†ä¸€æšå¼•ãã‹æ±ºã‚ã‚‹
       this.cpu.getCard,
       this.dispGame(0), 
       this.user.getCard,
       this.dispGame(0),
  
       // ã‚«ãƒ¼ãƒ‰å…¨è¡¨ç¤º
       this.dispGame(1),
       this.disp.blink(0 , 8 , "CPU:" & this.cpu.getCardSum(^tmp) & " USER:" & this.user.getCardSum(^tmp) , 3),
  
       // å‹ã¡è² ã‘åˆ¤å®š
       cpubest = this.cpu.getCardSum(^tmp),
       userbest = this.user.getCardSum(^tmp),
       draw = 0 , 
       userwin = 0 , 
       if((cpubest > 21 && userbest > 21) || (cpubest == userbest) ,
        // å¼•ãåˆ†ã‘
        {
         draw = 1
        },
        // å¼•ãåˆ†ã‘ä»¥å¤–
        if(cpubest > 21 ,
         // user ãŒå‹ã¡
         {
          userwin = 1
         },
         // cpu ãŒå‹ã¡
         if(userbest > 21 , 
          {
           userwin = 0
          },
          if(userbest > cpubest ,
           // user ãŒå‹ã¡
           userwin = 1
          )
         )
        )
       ),
       if(draw , 
        // å¼•ãåˆ†ã‘
        {
         this.disp.blink(0 , 9 , "DRAW" , 3),
         this.cpu.money = this.cpu.money + this.cpu.bet ,
         this.user.money = this.user.money + this.user.bet
        },
        if(userwin ,
         // userãŒå‹ã¡
         {
          this.disp.blink(0 , 9 , "USER WIN" , 3),
          this.cpu.money = this.cpu.money - this.user.bet ,
          this.user.money = this.user.money + this.user.bet * 2 + this.cpu.bet
         },
         // cpuãŒå‹ã¡
         {
          this.disp.blink(0 , 9 , "CPU WIN" , 3),
          this.cpu.money = this.cpu.money + this.cpu.bet * 2 + this.user.bet ,
          this.user.money = this.user.money - this.cpu.bet
         }
        )
       ),
  
       this.dispGame(1),
       clearcnt = clearcnt + 1 ,
  
       if(!draw && this.cpu.money <= 0 ,
        // user win
        {
         this.disp.blink(0 , 9 , "******* NEXT LEVEL *******" , 3),
         this.cpu.lv = this.cpu.lv + 1 ,
         this.score = this.score + this.cpu.lv * 1000 ,
         addscore = (10 - clearcnt) * 100 , // å›æ•°ãƒœãƒ¼ãƒŠã‚¹
         if(addscore < 0 , addscore = 0),
         this.score = this.score + addscore,
         this.cpu.moneyInit,
         clearcnt = 0
        }
       ),
  
       // åˆæœŸåŒ–
       this.card.init,
       this.cpu.init,
       this.user.init,
      }
     ),
     this.disp.blink(0 , 10 , "          GAME OVER                ",3),
     this.disp.disp
    }
  // ++
   ),
  // -----------------------------------------------------------------------
  }
 ),
  
 // ã‚²ãƒ¼ãƒ èµ·å‹•
 gm = newCMain,
 gm.main
}
